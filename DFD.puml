' ============================================================
' DFD â€“ Data Flow Diagram Core (Evaluated Stdlib-style)
' ============================================================

' Guard
!ifndef __DFD_BASE_LOADED__
!define __DFD_BASE_LOADED__

' ------------------------------------------------------------
' Runtime state
' ------------------------------------------------------------
!global __DFD_INITIALIZED = %false()
!global $__DFD_LEVEL = -1

' ------------------------------------------------------------
' Default settings
' ------------------------------------------------------------

' Title
!$DEFAULT_TITLE_FONTSIZE = 16
!$DEFAULT_SUBTITLE_FONTSIZE = 10
!$TITLE_FONTSIZE = $DEFAULT_TITLE_FONTSIZE
!$SUBTITLE_FONTSIZE = $DEFAULT_SUBTITLE_FONTSIZE

' Component
!$DEFAULT_STYLE = "filled"
!$DEFAULT_FILLCOLOR = "lightsteelblue1"
!$DEFAULT_FONTCOLOR = "#000000"
!$DEFAULT_FONTSIZE = 12
!$DEFAULT_BORDERCOLOR = "grey"
!$DEFAULT_WIDTH = 2
!$DEFAULT_HEIGHT = 1

' External
!$DEFAULT_EXTERNAL_SHAPE = "rectangle"
!$DEFAULT_EXTERNAL_FILLCOLOR = "lightgray"

' Process
!$DEFAULT_PROCESS_SHAPE = "circle"
!$DEFAULT_PROCESS_FILLCOLOR = "lightsteelblue1"

' Flow
!$DEFAULT_ARROW_STYLE = "solid"
!$DEFAULT_ARROW_COLOR = "black"
!$DEFAULT_ARROW_FONTCOLOR = "black"
!$DEFAULT_ARROW_FONTSIZE = 13
!$DEFAULT_PENWIDTH = 1

' Layout
!$DEFAULT_RANKDIR = "LR"
!$DEFAULT_RANKSEP = 1.5
!$DEFAULT_NODESEP = 0.5
!$DEFAULT_SPLINES = "spline"
!$DEFAULT_CONCENTRATE = "false"

' ------------------------------------------------------------
' Variable initialization
' ------------------------------------------------------------
!$STYLE = $DEFAULT_STYLE
!$FILLCOLOR = $DEFAULT_FILLCOLOR
!$FONTCOLOR = $DEFAULT_FONTCOLOR
!$FONTSIZE = $DEFAULT_FONTSIZE
!$BORDERCOLOR = $DEFAULT_BORDERCOLOR
!$WIDTH = $DEFAULT_WIDTH
!$HEIGHT = $DEFAULT_HEIGHT

!$RANKDIR = $DEFAULT_RANKDIR
!$RANKSEP = $DEFAULT_RANKSEP
!$NODESEP = $DEFAULT_NODESEP
!$SPLINES = $DEFAULT_SPLINES
!$CONCENTRATE = $DEFAULT_CONCENTRATE

!$ARROW_STYLE = $DEFAULT_ARROW_STYLE
!$ARROW_COLOR = $DEFAULT_ARROW_COLOR
!$ARROW_FONTCOLOR = $DEFAULT_ARROW_FONTCOLOR
!$ARROW_FONTSIZE = $DEFAULT_ARROW_FONTSIZE
!$PENWIDTH = $DEFAULT_PENWIDTH

!global $LEVEL = "DFD Diagram"

' ------------------------------------------------------------
' Core init
' ------------------------------------------------------------
!procedure DFD_INIT()
  !global __DFD_INITIALIZED = %true()
!endprocedure

' ------------------------------------------------------------
' Title
' ------------------------------------------------------------
!procedure Title($title)
  graph [rankdir=$RANKDIR ranksep=$RANKSEP labeljust=c labelloc=t \
  label=<<TABLE BORDER="0" CELLBORDER="0"> \
  <TR><TD><FONT POINT-SIZE="$TITLE_FONTSIZE">$title</FONT></TD></TR> \
  <TR><TD><FONT POINT-SIZE="$SUBTITLE_FONTSIZE">$LEVEL</FONT></TD></TR> \
  </TABLE>> ]
!endprocedure

' ------------------------------------------------------------
' Diagram start/end
' ------------------------------------------------------------
!procedure startDfd($title)
  !if not __DFD_INITIALIZED
    DFD_INIT()
  !endif
  digraph dfd {
    Title($title)
    splines=$SPLINES
    concentrate=$CONCENTRATE
    nodesep=$NODESEP
    node [shape=record]
!endprocedure

!procedure endDfd()
  }
!endprocedure

' ------------------------------------------------------------
' Base component renderer (internal)
' ------------------------------------------------------------
!unquoted procedure __Component($alias, $label, $shape, $fill)
  $alias [
    label="$label"
    shape=$shape
    style=$STYLE
    fillcolor=$fill
    fontcolor=$FONTCOLOR
    fontsize=$FONTSIZE
    color=$BORDERCOLOR
    width=$WIDTH
    height=$HEIGHT
  ]
!endprocedure

' ------------------------------------------------------------
' Flows
' ------------------------------------------------------------
!unquoted procedure __Flow($from, $to, $label="", $dir="forward")
  !if ($label != "")
    $from -> $to [
      label="$label"
      dir="$dir"
      style=$ARROW_STYLE
      color=$ARROW_COLOR
      penwidth=$PENWIDTH
      fontcolor=$ARROW_FONTCOLOR
      fontsize=$ARROW_FONTSIZE
    ]
  !else
    $from -> $to [dir="$dir"]
  !endif
!endprocedure

!unquoted procedure Flow($from, $to, $label="")
  __Flow($from, $to, $label, "forward")
!endprocedure

!unquoted procedure BiFlow($from, $to, $label="")
  __Flow($from, $to, $label, "both")
!endprocedure

!unquoted procedure Flow_Back($from, $to, $label="")
  __Flow($from, $to, $label, "back")
!endprocedure

!endif
