' DFD â€“ Data Flow Diagram core library
' PlantUML Standard Library candidate


' Guard (prevent double include)
' #############################################################################

!ifndef __DFD_STDLIB_LOADED__
!define __DFD_STDLIB_LOADED__

' Runtime state initialization
!global __DFD_LOADED = %true()
!global __DFD_INITIALIZED = %false()
!global __DFD_ERROR_COUNT = 0
!global __DFD_WARNING_COUNT = 0


' Versioning & metadata
' #############################################################################

' Version constants
!global $DFD_VERSION_MAJOR = 1
!global $DFD_VERSION_MINOR = 0
!global $DFD_VERSION_PATCH = 0
!global $DFD_VERSION_BUILD = 0

' Version string construction
!function $DFD_VERSION_STRING()
  !return $DFD_VERSION_MAJOR + "." + $DFD_VERSION_MINOR + "." + $DFD_VERSION_PATCH
!endfunction

!global $DFD_VERSION = $DFD_VERSION_STRING()

' Version metadata
!global $DFD_VERSION_DATE = "2024-01-01"
!global $DFD_VERSION_STATUS = "alpha"

' Public version function (stdlib API)
!function DFD_Version()
  !return $DFD_VERSION_STRING()
!endfunction

' Version check procedures
!function $DFD_CHECK_VERSION($major, $minor, $patch)
  !if ($major < 1)
    !return %false()
  !endif
  !if ($major == 1 and $minor < 0)
    !return %false()
  !endif
  !return %true()
!endfunction

' Get version info as formatted string
!function $DFD_GET_VERSION_INFO()
  !return "DFD PlantUML v" + $DFD_VERSION + " (" + $DFD_VERSION_STATUS + ")"
!endfunction

' Version check procedure (can be called by users)
!procedure DFD_VERSION_CHECK()
  ' Version information is available via DFD_Version() function
  ' This procedure is a placeholder for future enhancements
!endprocedure

' Migration helpers
!function $DFD_NEEDS_MIGRATION($oldVersion)
  ' This can be enhanced to check against known breaking changes
  !return %false()
!endfunction

' Deprecation tracking
!global $DFD_DEPRECATED_FEATURES = ""

' Mark a feature as deprecated
!procedure __DFD_MARK_DEPRECATED($feature, $replacement)
  !if ($DFD_DEPRECATED_FEATURES == "")
    !$DFD_DEPRECATED_FEATURES = $feature + "->" + $replacement
  !else
    !$DFD_DEPRECATED_FEATURES = $DFD_DEPRECATED_FEATURES + ";" + $feature + "->" + $replacement
  !endif
!endprocedure


' Global defaults
' #############################################################################

!global DFD_THEME ?= "light"
!global DFD_DEBUG ?= 0
!global __DFD_LEVEL ?= -1   ' -1 = unrestricted

' Profile flags (set by level profiles, defaults allow unrestricted mode)
!global __DFD_ALLOW_DATASTORE ?= 1
!global __DFD_ALLOW_MULTI_PROCESS ?= 1
!global __DFD_ALLOW_SUBPROCESS ?= 0
!global __DFD_ALLOW_TECH_FLOWS ?= 0

' Feature flags
!global $DFD_ENABLE_LEGEND ?= 1
!global $DFD_ENABLE_VALIDATION ?= 1
!global $DFD_ENABLE_NODE_REGISTRY ?= 1
!global $DFD_ENABLE_AUTO_LAYOUT ?= 1

' Notation settings
!global $DFD_NOTATION ?= "DEFAULT"

' Default title settings
!global $DEFAULT_TITLE_FONTSIZE = 16
!global $DEFAULT_SUBTITLE_FONTSIZE = 10
!global $DEFAULT_TITLE_FONTCOLOR = "#000000"
!global $DEFAULT_SUBTITLE_FONTCOLOR = "#666666"

' Current title settings (can be overridden)
!global $TITLE_FONTSIZE ?= $DEFAULT_TITLE_FONTSIZE
!global $SUBTITLE_FONTSIZE ?= $DEFAULT_SUBTITLE_FONTSIZE
!global $TITLE_FONTCOLOR ?= $DEFAULT_TITLE_FONTCOLOR
!global $SUBTITLE_FONTCOLOR ?= $DEFAULT_SUBTITLE_FONTCOLOR

' Level description (set by level profiles)
!global $LEVEL ?= "DFD Diagram"

' Default component settings
!global $DEFAULT_STYLE = "filled"
!global $DEFAULT_FILLCOLOR = "lightsteelblue1"
!global $DEFAULT_FONTCOLOR = "#000000"
!global $DEFAULT_FONTSIZE = 12
!global $DEFAULT_BORDERCOLOR = "grey"
!global $DEFAULT_WIDTH = 2
!global $DEFAULT_HEIGHT = 1

' Current component settings (can be overridden)
!global $STYLE ?= $DEFAULT_STYLE
!global $FILLCOLOR ?= $DEFAULT_FILLCOLOR
!global $FONTCOLOR ?= $DEFAULT_FONTCOLOR
!global $FONTSIZE ?= $DEFAULT_FONTSIZE
!global $BORDERCOLOR ?= $DEFAULT_BORDERCOLOR
!global $WIDTH ?= $DEFAULT_WIDTH
!global $HEIGHT ?= $DEFAULT_HEIGHT

' External entity default settings
!global $DEFAULT_EXTERNAL_STYLE = "filled"
!global $DEFAULT_EXTERNAL_FILLCOLOR = "lightgray"
!global $DEFAULT_EXTERNAL_FONTCOLOR = "#000000"
!global $DEFAULT_EXTERNAL_FONTSIZE = 12
!global $DEFAULT_EXTERNAL_BORDERCOLOR = "grey"
!global $DEFAULT_EXTERNAL_SHAPE = "box"
!global $DEFAULT_EXTERNAL_WIDTH = 2
!global $DEFAULT_EXTERNAL_HEIGHT = 2

' Current external entity settings
!global $EXTERNAL_STYLE ?= $DEFAULT_EXTERNAL_STYLE
!global $EXTERNAL_FILLCOLOR ?= $DEFAULT_EXTERNAL_FILLCOLOR
!global $EXTERNAL_FONTCOLOR ?= $DEFAULT_EXTERNAL_FONTCOLOR
!global $EXTERNAL_FONTSIZE ?= $DEFAULT_EXTERNAL_FONTSIZE
!global $EXTERNAL_BORDERCOLOR ?= $DEFAULT_EXTERNAL_BORDERCOLOR
!global $EXTERNAL_SHAPE ?= $DEFAULT_EXTERNAL_SHAPE
!global $EXTERNAL_WIDTH ?= $DEFAULT_EXTERNAL_WIDTH
!global $EXTERNAL_HEIGHT ?= $DEFAULT_EXTERNAL_HEIGHT

' Process default settings
!global $DEFAULT_PROCESS_STYLE = "filled"
!global $DEFAULT_PROCESS_FILLCOLOR = "lightsteelblue1"
!global $DEFAULT_PROCESS_FONTCOLOR = "#000000"
!global $DEFAULT_PROCESS_FONTSIZE = 12
!global $DEFAULT_PROCESS_BORDERCOLOR = "grey"
!global $DEFAULT_PROCESS_SHAPE = "Mrecord"
!global $DEFAULT_PROCESS_WIDTH = 2
!global $DEFAULT_PROCESS_HEIGHT = 1

' Current process settings
!global $PROCESS_STYLE ?= $DEFAULT_PROCESS_STYLE
!global $PROCESS_FILLCOLOR ?= $DEFAULT_PROCESS_FILLCOLOR
!global $PROCESS_FONTCOLOR ?= $DEFAULT_PROCESS_FONTCOLOR
!global $PROCESS_FONTSIZE ?= $DEFAULT_PROCESS_FONTSIZE
!global $PROCESS_BORDERCOLOR ?= $DEFAULT_PROCESS_BORDERCOLOR
!global $PROCESS_SHAPE ?= $DEFAULT_PROCESS_SHAPE
!global $PROCESS_WIDTH ?= $DEFAULT_PROCESS_WIDTH
!global $PROCESS_HEIGHT ?= $DEFAULT_PROCESS_HEIGHT

' Data store default settings
!global $DEFAULT_DATASTORE_STYLE = "filled"
!global $DEFAULT_DATASTORE_FILLCOLOR = "lightgreen"
!global $DEFAULT_DATASTORE_FONTCOLOR = "#000000"
!global $DEFAULT_DATASTORE_FONTSIZE = 12
!global $DEFAULT_DATASTORE_BORDERCOLOR = "grey"
!global $DEFAULT_DATASTORE_SHAPE = "record"
!global $DEFAULT_DATASTORE_WIDTH = 2
!global $DEFAULT_DATASTORE_HEIGHT = 1

' Current data store settings
!global $DATASTORE_STYLE ?= $DEFAULT_DATASTORE_STYLE
!global $DATASTORE_FILLCOLOR ?= $DEFAULT_DATASTORE_FILLCOLOR
!global $DATASTORE_FONTCOLOR ?= $DEFAULT_DATASTORE_FONTCOLOR
!global $DATASTORE_FONTSIZE ?= $DEFAULT_DATASTORE_FONTSIZE
!global $DATASTORE_BORDERCOLOR ?= $DEFAULT_DATASTORE_BORDERCOLOR
!global $DATASTORE_SHAPE ?= $DEFAULT_DATASTORE_SHAPE
!global $DATASTORE_WIDTH ?= $DEFAULT_DATASTORE_WIDTH
!global $DATASTORE_HEIGHT ?= $DEFAULT_DATASTORE_HEIGHT

' Flow default settings
!global $DEFAULT_ARROW_STYLE = "solid"
!global $DEFAULT_ARROW_COLOR = "black"
!global $DEFAULT_ARROW_FONTCOLOR = "black"
!global $DEFAULT_ARROW_FONTSIZE = 13
!global $DEFAULT_PENWIDTH = 1

' Current flow settings
!global $ARROW_STYLE ?= $DEFAULT_ARROW_STYLE
!global $ARROW_COLOR ?= $DEFAULT_ARROW_COLOR
!global $ARROW_FONTCOLOR ?= $DEFAULT_ARROW_FONTCOLOR
!global $ARROW_FONTSIZE ?= $DEFAULT_ARROW_FONTSIZE
!global $PENWIDTH ?= $DEFAULT_PENWIDTH

' Layout default settings
!global $DEFAULT_RANKDIR = "LR"
!global $DEFAULT_RANKSEP = 1.5
!global $DEFAULT_NODESEP = 0.5
!global $DEFAULT_SPLINES = "spline"
!global $DEFAULT_CONCENTRATE = "false"
!global $DEFAULT_CONSTRAINT = "true"
!global $DEFAULT_LAYOUT_ENGINE = "dot"

' Current layout settings
!global $RANKDIR ?= $DEFAULT_RANKDIR
!global $RANKSEP ?= $DEFAULT_RANKSEP
!global $NODESEP ?= $DEFAULT_NODESEP
!global $SPLINES ?= $DEFAULT_SPLINES
!global $CONCENTRATE ?= $DEFAULT_CONCENTRATE
!global $CONSTRAINT ?= $DEFAULT_CONSTRAINT
!global $LAYOUT_ENGINE ?= $DEFAULT_LAYOUT_ENGINE

' Group/cluster default settings
!global $DEFAULT_GROUP_STYLE = "dashed"
!global $DEFAULT_GROUP_COLOR = "gray"

' Current group settings
!global $GROUP_STYLE ?= $DEFAULT_GROUP_STYLE
!global $GROUP_COLOR ?= $DEFAULT_GROUP_COLOR

' Shape constants
!global $MRECORD = "Mrecord"
!global $RECT = "rect"
!global $CIRCLE = "circle"
!global $RECORD = "record"
!global $OVAL = "oval"
!global $BOX = "box"


' Compatibility helpers (RFC compliant)
' #############################################################################

!function DFD_NewLine()
  !if %function_exists("%breakline")
    !return %breakline()
  !endif
  !return %newline()
!endfunction


' Internal
' #############################################################################

' Node registry initialization
!global __DFD_NODE_REGISTRY = ""
!global __dfd_nodes = ""
!global __dfd_process_count = 0

' Register a node alias
!procedure DFD_REGISTER_NODE($alias)
  !if ($DFD_ENABLE_NODE_REGISTRY == 1)
    !if ($__DFD_NODE_REGISTRY == "")
      !$__DFD_NODE_REGISTRY = $alias
    !else
      !$__DFD_NODE_REGISTRY = $__DFD_NODE_REGISTRY + "," + $alias
    !endif
  !endif
  ' Also maintain legacy format for compatibility
  !if %strpos($__dfd_nodes, "|" + $alias + "|") < 0
    !$__dfd_nodes = $__dfd_nodes + "|" + $alias + "|"
  !endif
!endprocedure

' Check if a node is registered
!function DFD_NODE_EXISTS($alias)
  !if ($DFD_ENABLE_NODE_REGISTRY == 1)
    !return %string_contains($__DFD_NODE_REGISTRY, $alias) or %strpos($__dfd_nodes, "|" + $alias + "|") >= 0
  !else
    !return %true()
  !endif
!endfunction

' Internal node existence check (for registry)
!function __DFD_NODE_EXISTS($alias)
  !return %string_contains($__DFD_NODE_REGISTRY, $alias) or %strpos($__dfd_nodes, "|" + $alias + "|") >= 0
!endfunction

' Register a node when an element is created
!procedure __DFD_REGISTER_ELEMENT($alias, $elementType)
  !if ($DFD_ENABLE_NODE_REGISTRY == 1)
    DFD_REGISTER_NODE($alias)
  !endif
!endprocedure

' Validate flow source and destination nodes
!procedure __DFD_VALIDATE_FLOW($from, $to)
  !if ($DFD_ENABLE_VALIDATION == 1 and $DFD_ENABLE_NODE_REGISTRY == 1)
    !if (not DFD_NODE_EXISTS($from))
      !error "Flow source node '" + $from + "' does not exist"
    !endif
    !if (not DFD_NODE_EXISTS($to))
      !error "Flow destination node '" + $to + "' does not exist"
    !endif
  !endif
!endprocedure

' Get node count (for statistics/debugging)
!function $DFD_GET_NODE_COUNT()
  !if ($__DFD_NODE_REGISTRY == "")
    !return 0
  !endif
  ' Simple approximation - count commas + 1
  !return 1
!endfunction

' Clear node registry (for testing/reset)
!procedure DFD_CLEAR_REGISTRY()
  !global __DFD_NODE_REGISTRY = ""
  !global __dfd_nodes = ""
!endprocedure

' Error handling infrastructure
!procedure __DFD_ERROR($message)
  !$__DFD_ERROR_COUNT = $__DFD_ERROR_COUNT + 1
  !error $message
!endprocedure

!procedure __DFD_WARNING($message)
  !$__DFD_WARNING_COUNT = $__DFD_WARNING_COUNT + 1
  ' Note: PlantUML doesn't have a built-in warning mechanism
!endprocedure


' Colors
' #############################################################################

' Base color functions
!function DFD_Color_Process()
  !return "#E3F2FD"
!endfunction

!function DFD_Color_External()
  !return "#FFFDE7"
!endfunction

!function DFD_Color_DataStore()
  !return "#E8F5E9"
!endfunction

!function DFD_Color_Flow()
  !return "#424242"
!endfunction

' Color helpers (for future dark mode support)
!function $DFD_IS_DARK_MODE()
  !return %false()
!endfunction

!function $DFD_GET_COLOR($lightColor, $darkColor)
  !if ($DFD_IS_DARK_MODE())
    !return $darkColor
  !else
    !return $lightColor
  !endif
!endfunction


' Labels
' #############################################################################

' Title/Subtitle Customization
!procedure SetTitleFontSize($size)
  !$TITLE_FONTSIZE = $size
!endprocedure

!procedure SetTitleFontColor($color)
  !$TITLE_FONTCOLOR = $color
!endprocedure

!procedure SetSubtitleFontSize($size)
  !$SUBTITLE_FONTSIZE = $size
!endprocedure

!procedure SetSubtitleFontColor($color)
  !$SUBTITLE_FONTCOLOR = $color
!endprocedure

' Label formatting function (used by element creation)
!unquoted function getLabel($label, $id, $elementType)
  !$formattedLabel = ""
  !if ($elementType == "process")
    !if ($id != "")
      !$formattedLabel = $id + " | " + $label + "\n\n\n"
    !else
      !$formattedLabel = $label + "\n\n\n"
    !endif
  !endif
  !if ($elementType == "external")
    !$formattedLabel = $label
  !endif
  !if ($elementType == "datastore")
    !if ($id != "")
      !$formattedLabel = "{<f0>" + $id + " |<f1> " + $label + "}"
    !else
      !$formattedLabel = "{<f0>D |<f1> " + $label + "}"
    !endif
  !endif
  !return $formattedLabel
!endfunction

' Title procedure for digraph labels
!unquoted procedure Title($title)
  graph [rankdir=LR ranksep=1.5 splines=true overlap=false labeljust=c labelloc=t \
  label=<<TABLE BORDER="0" CELLBORDER="0"> \
  <TR><TD><FONT POINT-SIZE="$TITLE_FONTSIZE">$title</FONT></TD></TR> \
  <TR><TD><FONT POINT-SIZE="$SUBTITLE_FONTSIZE">$LEVEL</FONT></TD></TR> \
  </TABLE>> ]
!endprocedure


' Styles
' #############################################################################

' Component Style Customization
!procedure SetComponentStyle($style="filled")
  !$STYLE = $style
!endprocedure

!procedure SetComponentFillColor($color="lightsteelblue1")
  !$FILLCOLOR = $color
!endprocedure

!procedure SetComponentFontColor($color="#000000")
  !$FONTCOLOR = $color
!endprocedure

!procedure SetComponentFontSize($size=12)
  !$FONTSIZE = $size
!endprocedure

!procedure SetComponentBorderColor($color="grey")
  !$BORDERCOLOR = $color
!endprocedure

!procedure SetComponentSize($width=2, $height=1)
  !$WIDTH = $width
  !$HEIGHT = $height
!endprocedure

' External Entity Customization
!procedure SetExternalStyle($style="filled")
  !$EXTERNAL_STYLE = $style
!endprocedure

!procedure SetExternalFillColor($color="lightgray")
  !$EXTERNAL_FILLCOLOR = $color
!endprocedure

!procedure SetExternalFontColor($color="#000000")
  !$EXTERNAL_FONTCOLOR = $color
!endprocedure

!procedure SetExternalFontSize($size=12)
  !$EXTERNAL_FONTSIZE = $size
!endprocedure

!procedure SetExternalBorderColor($color="grey")
  !$EXTERNAL_BORDERCOLOR = $color
!endprocedure

!procedure SetExternalShape($shape="box")
  !$EXTERNAL_SHAPE = $shape
!endprocedure

!procedure SetExternalSize($width=2, $height=2)
  !$EXTERNAL_WIDTH = $width
  !$EXTERNAL_HEIGHT = $height
!endprocedure

' Process Customization
!procedure SetProcessStyle($style="filled")
  !$PROCESS_STYLE = $style
!endprocedure

!procedure SetProcessFillColor($color="lightsteelblue1")
  !$PROCESS_FILLCOLOR = $color
!endprocedure

!procedure SetProcessFontColor($color="#000000")
  !$PROCESS_FONTCOLOR = $color
!endprocedure

!procedure SetProcessFontSize($size=12)
  !$PROCESS_FONTSIZE = $size
!endprocedure

!procedure SetProcessBorderColor($color="grey")
  !$PROCESS_BORDERCOLOR = $color
!endprocedure

!procedure SetProcessShape($shape="Mrecord")
  !$PROCESS_SHAPE = $shape
!endprocedure

!procedure SetProcessSize($width=2, $height=1)
  !$PROCESS_WIDTH = $width
  !$PROCESS_HEIGHT = $height
!endprocedure

' Data Store Customization
!procedure SetDataStoreStyle($style="filled")
  !$DATASTORE_STYLE = $style
!endprocedure

!procedure SetDataStoreFillColor($color="lightgreen")
  !$DATASTORE_FILLCOLOR = $color
!endprocedure

!procedure SetDataStoreFontColor($color="#000000")
  !$DATASTORE_FONTCOLOR = $color
!endprocedure

!procedure SetDataStoreFontSize($size=12)
  !$DATASTORE_FONTSIZE = $size
!endprocedure

!procedure SetDataStoreBorderColor($color="grey")
  !$DATASTORE_BORDERCOLOR = $color
!endprocedure

!procedure SetDataStoreShape($shape="record")
  !$DATASTORE_SHAPE = $shape
!endprocedure

!procedure SetDataStoreSize($width=2, $height=1)
  !$DATASTORE_WIDTH = $width
  !$DATASTORE_HEIGHT = $height
!endprocedure

' Flow Style Customization
!procedure SetFlowStyle($style="solid")
  !$ARROW_STYLE = $style
!endprocedure

!procedure SetFlowColor($color="black")
  !$ARROW_COLOR = $color
!endprocedure

!procedure SetFlowFontColor($color="black")
  !$ARROW_FONTCOLOR = $color
!endprocedure

!procedure SetFlowFontSize($size=13)
  !$ARROW_FONTSIZE = $size
!endprocedure

!procedure SetFlowPenWidth($width=1)
  !$PENWIDTH = $width
!endprocedure

' Layout Customization
!procedure SetRankDir($dir="LR")
  !$RANKDIR = $dir
!endprocedure

!procedure SetSplines($type="spline")
  !$SPLINES = $type
!endprocedure

!procedure SetLayout($engine="dot")
  !$LAYOUT_ENGINE = $engine
!endprocedure

!procedure SetNodeSep($sep=0.5)
  !$NODESEP = $sep
!endprocedure

!procedure SetRankSep($sep=1.5)
  !$RANKSEP = $sep
!endprocedure

' Group/Cluster Customization
!procedure SetGroupStyle($style="dashed")
  !$GROUP_STYLE = $style
!endprocedure

!procedure SetGroupColor($color="gray")
  !$GROUP_COLOR = $color
!endprocedure

' Batch Customization Procedures
!procedure SetAllComponentColors($fillColor, $borderColor="grey", $fontColor="#000000")
  SetComponentFillColor($fillColor)
  SetExternalFillColor($fillColor)
  SetProcessFillColor($fillColor)
  SetDataStoreFillColor($fillColor)
  SetComponentBorderColor($borderColor)
  SetComponentFontColor($fontColor)
!endprocedure

!procedure SetAllComponentSizes($width=2, $height=1)
  SetComponentSize($width, $height)
  SetExternalSize($width, $height)
  SetProcessSize($width, $height)
  SetDataStoreSize($width, $height)
!endprocedure

!procedure SetAllComponentStyles($style="filled")
  SetComponentStyle($style)
  SetExternalStyle($style)
  SetProcessStyle($style)
  SetDataStoreStyle($style)
!endprocedure

' Flow Layout Customization (for digraph mode compatibility)
!procedure SetFlowSplines($type="spline")
  !$SPLINES = $type
!endprocedure

!procedure SetFlowConcentrate($value="false")
  !$CONCENTRATE = $value
!endprocedure

!procedure SetFlowRankDir($dir="LR")
  !$RANKDIR = $dir
!endprocedure

!procedure SetFlowRankSep($sep=1.5)
  !$RANKSEP = $sep
!endprocedure

!procedure SetFlowNodeSep($sep=0.5)
  !$NODESEP = $sep
!endprocedure

!procedure SetFlowConstraint($value="true")
  !$CONSTRAINT = $value
!endprocedure

' Flow Type Presets
!procedure SetFlowType($type="normal")
  !if ($type == "normal")
    SetFlowStyle("solid")
    SetFlowPenWidth(1)
  !elseif ($type == "bold")
    SetFlowStyle("bold")
    SetFlowPenWidth(2)
  !elseif ($type == "dashed")
    SetFlowStyle("dashed")
    SetFlowPenWidth(1)
  !elseif ($type == "dotted")
    SetFlowStyle("dotted")
    SetFlowPenWidth(1)
  !endif
!endprocedure

!procedure SetFlowDirection($dir="forward")
  !if ($dir == "forward")
    SetRankDir("LR")
  !elseif ($dir == "backward")
    SetRankDir("RL")
  !elseif ($dir == "down")
    SetRankDir("TB")
  !elseif ($dir == "up")
    SetRankDir("BT")
  !endif
!endprocedure

' Flow Layout Presets
!procedure SetFlowLayoutOrthogonal()
  SetFlowSplines("ortho")
  SetFlowConcentrate("true")
!endprocedure

!procedure SetFlowLayoutCurved()
  SetFlowSplines("curved")
  SetFlowConcentrate("false")
!endprocedure

!procedure SetFlowLayoutDirect()
  SetFlowSplines("line")
  SetFlowConcentrate("false")
!endprocedure

' Batch Flow Customization
!procedure SetAllFlowProperties($style="solid", $color="black", $fontColor="black", $fontSize=13, $penWidth=1)
  SetFlowStyle($style)
  SetFlowColor($color)
  SetFlowFontColor($fontColor)
  SetFlowFontSize($fontSize)
  SetFlowPenWidth($penWidth)
!endprocedure

' Dark Mode Integration
!procedure SetComponentFillColorDarkAware($lightColor, $darkColor="")
  !if ($darkColor == "")
    SetComponentFillColor($lightColor)
  !elseif (%function_exists("$DFD_GET_COLOR"))
    !$color = $DFD_GET_COLOR($lightColor, $darkColor)
    SetComponentFillColor($color)
  !else
    SetComponentFillColor($lightColor)
  !endif
!endprocedure

' Initialization
' #############################################################################

!procedure DFD_INIT_BASE()
  ' Initialize node registry if enabled
  !if ($DFD_ENABLE_NODE_REGISTRY == 1)
    !global __DFD_NODE_REGISTRY = ""
    !global __dfd_nodes = ""
  !endif
  
  ' Apply default skin parameters
  skinparam shadowing false
  skinparam ArrowColor DFD_Color_Flow()
  skinparam RectangleBackgroundColor DFD_Color_Process()
  skinparam ActorBackgroundColor DFD_Color_External()
  skinparam DatabaseBackgroundColor DFD_Color_DataStore()
  
  ' Mark as initialized
  !global __DFD_INITIALIZED = %true()
!endprocedure

' Public INIT (overridable by profiles)
!procedure DFD_INIT()
  DFD_INIT_BASE()
!endprocedure

' Start DFD diagram (digraph mode)
!unquoted procedure startDfd($title="")
  !if (not __DFD_INITIALIZED)
    DFD_INIT()
  !endif
  
  digraph dfd {
  !if ($title != "")
    Title($title)
  !endif
  node[shape=record]
!endprocedure

' End DFD diagram
!procedure endDfd()
  }
!endprocedure


' Elements
' #############################################################################

' Base component creation procedure (digraph mode)
!unquoted procedure Component($alias, $label, $id="", $shape, $fillcolor, $width, $height, $elementType)
  !$formattedLabel = getLabel($label, $id, $elementType)
  
  ' Get element-specific style variables
  !if ($elementType == "process")
    !$elemStyle = $PROCESS_STYLE
    !$elemFontColor = $PROCESS_FONTCOLOR
    !$elemFontSize = $PROCESS_FONTSIZE
    !$elemBorderColor = $PROCESS_BORDERCOLOR
  !elseif ($elementType == "external")
    !$elemStyle = $EXTERNAL_STYLE
    !$elemFontColor = $EXTERNAL_FONTCOLOR
    !$elemFontSize = $EXTERNAL_FONTSIZE
    !$elemBorderColor = $EXTERNAL_BORDERCOLOR
  !elseif ($elementType == "datastore")
    !$elemStyle = $DATASTORE_STYLE
    !$elemFontColor = $DATASTORE_FONTCOLOR
    !$elemFontSize = $DATASTORE_FONTSIZE
    !$elemBorderColor = $DATASTORE_BORDERCOLOR
  !else
    !$elemStyle = $STYLE
    !$elemFontColor = $FONTCOLOR
    !$elemFontSize = $FONTSIZE
    !$elemBorderColor = $BORDERCOLOR
  !endif
  
  ' Create the node using digraph syntax
  $alias [label="$formattedLabel" shape=$shape fillcolor=$fillcolor style=$elemStyle fontcolor=$elemFontColor fontsize=$elemFontSize color=$elemBorderColor width=$width height=$height]
  
  ' Register the node
  DFD_REGISTER_NODE($alias)
!endprocedure

' External Entity
!unquoted procedure DFD_External($alias, $label, $id="")
  Component($alias, $label, $id, $EXTERNAL_SHAPE, $EXTERNAL_FILLCOLOR, $EXTERNAL_WIDTH, $EXTERNAL_HEIGHT, "external")
!endprocedure

' Process
!unquoted procedure DFD_Process($alias, $label, $id="")
  !if __DFD_LEVEL == 0
    !if __dfd_process_count > 0
      !error "DFD Level 0 allows only one process"
    !endif
  !endif

  !$__dfd_process_count = $__dfd_process_count + 1
  Component($alias, $label, $id, $PROCESS_SHAPE, $PROCESS_FILLCOLOR, $PROCESS_WIDTH, $PROCESS_HEIGHT, "process")
!endprocedure

' Data Store
!unquoted procedure DFD_DataStore($alias, $label, $id="")
  !if __DFD_LEVEL == 0
    !error "Data stores are not allowed in DFD Level 0 (Context Diagram)"
  !endif
  !if __DFD_ALLOW_DATASTORE == 0
    !error "Data stores are not allowed at this DFD level"
  !endif

  Component($alias, $label, $id, $DATASTORE_SHAPE, $DATASTORE_FILLCOLOR, $DATASTORE_WIDTH, $DATASTORE_HEIGHT, "datastore")
!endprocedure

' Base flow procedure (internal - used by other flow procedures)
!unquoted procedure Flow_($from, $to, $label="", $direction="")
  __DFD_VALIDATE_FLOW($from, $to)
  
  !if ($label != "")
    $from -> $to [label="$label" dir=$direction style=$ARROW_STYLE color=$ARROW_COLOR penwidth=$PENWIDTH fontcolor=$ARROW_FONTCOLOR fontsize=$ARROW_FONTSIZE]
  !else
    $from -> $to [dir=$direction style=$ARROW_STYLE color=$ARROW_COLOR penwidth=$PENWIDTH]
  !endif
!endprocedure

' Data flows
!unquoted procedure DFD_Flow($from, $to, $label="")
  !if DFD_DEBUG == 1
    !if not DFD_NODE_EXISTS($from)
      !error "Source node '" + $from + "' does not exist"
    !endif
    !if not DFD_NODE_EXISTS($to)
      !error "Destination node '" + $to + "' does not exist"
    !endif
  !endif
  
  Flow_($from, $to, $label, forward)
!endprocedure

' Bidirectional flow
!unquoted procedure DFD_BiFlow($from, $to, $label="")
  Flow_($from, $to, $label, both)
!endprocedure

' Backward flow
!unquoted procedure DFD_Flow_Back($from, $to, $label="")
  Flow_($from, $to, $label, back)
!endprocedure

!endif
